.PHONY: build build-metrics create delete check clean deploy test load-test

help :
	@echo "Usage:"
	@echo "   make build        - build the plug-in"
	@echo "   make create       - create a kind cluster"
	@echo "   make delete       - delete the kind cluster"
	@echo "   make deploy       - deploy the apps to the cluster"
	@echo "   make check        - check the endpoints with curl"
	@echo "   make clean        - delete the apps from the cluster"
	@echo "   make test         - run a LodeRunner test (generates warnings)"
	@echo "   make load-test    - run a 60 second load test"
build:
	rustup toolchain install nightly
	rustup update
	rustup target add wasm32-unknown-unknown --toolchain nightly
	rustup default nightly
	cargo build --release --target=wasm32-unknown-unknown
	kind delete cluster --name cmdemo
	./kindlocalreg.sh cmdemo
	docker pull ghcr.io/retaildevcrews/ngsa-app:beta
	docker tag ghcr.io/retaildevcrews/ngsa-app:beta localhost:5000/retaildevcrews/ngsa-app:beta
	docker push localhost:5000/retaildevcrews/ngsa-app:beta
	docker build pymetric -t pymetric:local
	docker tag  pymetric:local localhost:5000/pymetric:local
	docker push localhost:5000/pymetric:local
	kubectl config get-contexts
	kubectl config use-context kind-cmdemo
	istioctl install --set profile=demo -y
	kubectl label namespace default istio-injection=enabled
	kubectl wait node --for condition=ready --all --timeout=60s
	kubectl delete --ignore-not-found -f  cmdemoyml/pymetric.yaml
	kubectl apply -f cmdemoyml/pymetric.yaml
	kubectl delete --ignore-not-found -f  cmdemoyml/pymetric-gw.yaml
	kubectl apply -f cmdemoyml/pymetric-gw.yaml
	kubectl wait node --for condition=ready --all --timeout=10s
	kubectl delete --ignore-not-found -f  cmdemoyml/ngsa.yaml
	kubectl apply -f cmdemoyml/ngsa.yaml
	kubectl delete --ignore-not-found -f  cmdemoyml/ngsa-gw.yaml
	kubectl apply -f cmdemoyml/ngsa-gw.yaml
	./patch.sh
	